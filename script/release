#!/usr/bin/env bash
set -Eeuo pipefail

usage() {
  echo "Usage: script/release {patch|minor|major}" >&2
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  usage
  exit 0
fi

if [ $# -ne 1 ]; then
  usage
  exit 2
fi

BUMP_TYPE="$1"
case "$BUMP_TYPE" in
  patch|minor|major) ;;
  *) echo "Invalid bump type: $BUMP_TYPE (must be patch|minor|major)" >&2; exit 2 ;;
esac

# Ensure working copy is clean (no staged/unstaged changes)
if [ -n "$(git status --porcelain)" ]; then
  echo "Working tree is not clean. Commit or stash changes before releasing." >&2
  git status --short
  exit 1
fi

## Bump version in package.json only (no git tag)
echo "Bumping version: npm version --no-git-tag-version $BUMP_TYPE"
npm version "$BUMP_TYPE" --no-git-tag-version

# Sync Ruby gem version file to the new package version
# Read version from package.json using Node for portability
VERSION=$(node -p "require('./package.json').version")
if [ -z "${VERSION:-}" ]; then
  echo "Unable to determine version from package.json" >&2
  exit 1
fi

RB_VERSION_FILE="lib/straight_to_video/version.rb"
if [ ! -f "$RB_VERSION_FILE" ]; then
  echo "Missing $RB_VERSION_FILE" >&2
  exit 1
fi

tmp_file="$RB_VERSION_FILE.tmp"
printf 'module StraightToVideo\n  VERSION = "%s"\nend\n' "$VERSION" > "$tmp_file"
mv "$tmp_file" "$RB_VERSION_FILE"

# Vendor javascript files (reflect new version in headers)
./script/vendor

# Bump the version in the Gemfile.lock
bundle

# Commit version bumps as a single commit; bundler's rake release will tag
git add package.json package-lock.json Gemfile.lock "$RB_VERSION_FILE" app/assets/javascripts
git commit -m "$VERSION"

# Publish to npm
echo "Publishing to npm (2FA may prompt)..."
npm publish

# Trigger JSPM build
echo "Triggering JSPM build for straight-to-video@${VERSION}..."
curl "https://api.jspm.io/build/straight-to-video@${VERSION}" >/dev/null || true

# Publish to rubygems.org
echo "Publishing RubyGems.org (2FA may prompt)..."
bundle exec rake release

echo "Done, $VERSION has been released to npm and RubyGems.org ðŸ“¼."
